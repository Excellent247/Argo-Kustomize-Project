name: Test pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  pre-build-checks:
    permissions:
      contents: read
      security-events: write
      id-token: write
    name: Security Pre-Build Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better secret detection

      # SECRET SCANNING
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true
  
      # # SAST - Semgrep
      # - name: Semgrep Security Scan
      #   uses: returntocorp/semgrep-action@v1
      #   with:
      #     config: >-
      #       p/security-audit
      #       p/secrets
      #       p/owasp-top-ten
      #       p/java
      #   env:
      #     SEMGREP_RULES: >-
      #       p/security-audit
      #       p/secrets
      #       p/owasp-top-ten

      # SCA - Dependency Scanning with Trivy (Filesystem)
      - name: Trivy Dependency Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-deps-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1' # Exit with code 1 if vulnerabilities found
          scanners: 'vuln,secret,config'

      - name: Upload Dependency Scan Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-deps-results.sarif'
          category: 'dependency-scan'